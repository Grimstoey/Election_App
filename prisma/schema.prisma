// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

// prisma 6, 7 ย้าย url = env("DATABASE_URL")
//ไปไว้ที่ prisma.config.ts
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================= ROLE & USER =================

model user {
  id        Int    @id @default(autoincrement())
  citizenId String @unique
  password  String

  firstName String
  lastName  String
  address   String

  // เลือกจาก dropdown เท่านั้น
  provinceId Int
  areaId     Int

  province province     @relation(fields: [provinceId], references: [id])
  area     districtArea @relation(fields: [areaId], references: [id])

  // เขตเลือกตั้งถูกกำหนดอัตโนมัติจาก area
  electionDistrictId Int
  electionDistrict   electionDistrict @relation(fields: [electionDistrictId], references: [id])

  roles userRole[]
  vote  vote?

  createdAt DateTime @default(now())
}

model role {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  userRoles userRole[]
}

model userRole {
  userId Int
  roleId Int

  user user @relation(fields: [userId], references: [id])
  role role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

// ================= LOCATION =================

model province {
  id   Int    @id @default(autoincrement())
  name String @unique

  areas districtArea[]
  users user[]
}

model districtArea {
  id         Int    @id @default(autoincrement())
  name       String //อำเภอ
  provinceId Int

  province  province           @relation(fields: [provinceId], references: [id])
  districts electionDistrict[]
  users     user[]

  // ป้องกันชื่อเขตซ้ำในจังหวัดเดียวกัน
  @@unique([name, provinceId])
}

model electionDistrict {
  id     Int @id @default(autoincrement())
  number Int // เลขเขต
  areaId Int //เลขอำเภอ

  area districtArea @relation(fields: [areaId], references: [id])

  isClosed Boolean @default(false)

  users      user[]
  candidates candidate[]

  //ป้องกันเขตซ้ำในพื้นที่เดิม
  @@unique([number, areaId])
}

// ================= PARTY =================

model party {
  id      Int    @id @default(autoincrement())
  name    String @unique
  logoUrl String
  policy  String

  candidates candidate[]
}

// ================= CANDIDATE =================

model candidate {
  id       Int    @id @default(autoincrement())
  number   Int
  fullName String
  imageUrl String

  partyId    Int
  districtId Int

  party    party            @relation(fields: [partyId], references: [id])
  district electionDistrict @relation(fields: [districtId], references: [id])

  votes vote[]

  @@unique([number, districtId])
}

// ================= VOTE =================

model vote {
  id          Int @id @default(autoincrement())
  userId      Int @unique
  candidateId Int

  user      user      @relation(fields: [userId], references: [id])
  candidate candidate @relation(fields: [candidateId], references: [id])

  createdAt DateTime @default(now())
}
